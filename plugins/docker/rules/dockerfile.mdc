---
description: Best practices for writing production-grade Dockerfiles
globs:
  - "Dockerfile*"
  - "**/*.dockerfile"
  - "**/Dockerfile*"
alwaysApply: false
---

# Dockerfile Best Practices

## Base Image Selection

- **Pin base image versions** — never use `latest`. Use specific tags with SHA digests for reproducibility:
  ```dockerfile
  # Good
  FROM node:20.11-alpine3.19@sha256:abcdef1234567890...
  # Acceptable
  FROM node:20.11-alpine3.19
  # Bad
  FROM node:latest
  ```
- Prefer minimal base images (`alpine`, `slim`, `distroless`) to reduce attack surface and image size.
- Use official images from Docker Hub or verified publishers.

## Multi-Stage Builds

- **Always use multi-stage builds** for compiled languages and applications with build dependencies:
  ```dockerfile
  # Build stage
  FROM node:20-alpine AS builder
  WORKDIR /app
  COPY package*.json ./
  RUN npm ci --only=production
  COPY . .
  RUN npm run build

  # Production stage
  FROM node:20-alpine AS production
  WORKDIR /app
  COPY --from=builder /app/dist ./dist
  COPY --from=builder /app/node_modules ./node_modules
  USER node
  CMD ["node", "dist/index.js"]
  ```
- Name stages clearly (`builder`, `test`, `production`) for readability.
- Copy only necessary artifacts from build stages into the final image.

## Layer Ordering and Cache Efficiency

- Order Dockerfile instructions from least to most frequently changing:
  1. Base image and system dependencies
  2. Language runtime configuration
  3. Dependency manifests (`package.json`, `requirements.txt`, `go.mod`)
  4. Install dependencies
  5. Copy application source code
  6. Build step
- **Copy dependency files before source code** to leverage Docker layer caching:
  ```dockerfile
  COPY package.json package-lock.json ./
  RUN npm ci
  COPY . .
  ```

## Minimize Layers

- Combine related `RUN` commands using `&&` and line continuations:
  ```dockerfile
  RUN apt-get update && \
      apt-get install -y --no-install-recommends \
        curl \
        ca-certificates && \
      rm -rf /var/lib/apt/lists/*
  ```
- Clean up caches and temporary files in the same layer they are created.

## Security

- **Run as non-root** — always include a `USER` instruction:
  ```dockerfile
  RUN addgroup -S appgroup && adduser -S appuser -G appgroup
  USER appuser
  ```
- Do not store secrets in the image. Use build secrets or runtime injection:
  ```dockerfile
  RUN --mount=type=secret,id=npmrc,target=/root/.npmrc npm ci
  ```
- Scan images for vulnerabilities using `docker scout`, `trivy`, or `grype`.
- Drop all capabilities and add only what is needed at runtime.
- Set `HEALTHCHECK` to enable orchestrator health monitoring:
  ```dockerfile
  HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
    CMD curl -f http://localhost:3000/health || exit 1
  ```

## Use COPY Instead of ADD

- Prefer `COPY` over `ADD` unless you specifically need tar extraction or URL fetching.
- `COPY` is explicit and predictable; `ADD` has implicit behaviors that can introduce surprises.

## Build Arguments and Labels

- Use `ARG` for configurable builds:
  ```dockerfile
  ARG NODE_ENV=production
  ENV NODE_ENV=${NODE_ENV}
  ```
- Add OCI-compliant labels for metadata:
  ```dockerfile
  LABEL org.opencontainers.image.source="https://github.com/org/repo"
  LABEL org.opencontainers.image.version="1.0.0"
  LABEL org.opencontainers.image.description="My application"
  ```

## .dockerignore

- **Always include a `.dockerignore`** file to exclude unnecessary files from the build context:
  ```
  node_modules
  .git
  .env
  *.md
  .github
  coverage
  dist
  .dockerignore
  Dockerfile
  docker-compose*.yml
  ```

## Entrypoint and CMD

- Use `ENTRYPOINT` for the main executable and `CMD` for default arguments:
  ```dockerfile
  ENTRYPOINT ["node"]
  CMD ["dist/index.js"]
  ```
- Prefer exec form (`["executable", "arg"]`) over shell form to ensure proper signal handling.
- Use `tini` or `dumb-init` as PID 1 if the application does not handle signals:
  ```dockerfile
  RUN apk add --no-cache tini
  ENTRYPOINT ["/sbin/tini", "--"]
  CMD ["node", "dist/index.js"]
  ```

## Miscellaneous

- Set `WORKDIR` explicitly — do not rely on the default.
- Avoid installing unnecessary packages. Use `--no-install-recommends` with apt.
- Use `.env` files or Docker secrets for environment-specific configuration, not hardcoded `ENV` values.
- Keep images small: target under 100 MB for microservices, under 500 MB for full-stack apps.
- Tag images with git SHA and semantic version for traceability.
